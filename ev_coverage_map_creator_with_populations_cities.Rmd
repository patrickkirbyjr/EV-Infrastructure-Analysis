---
title: "Quick Coverage Map Creator with Population Densities and Cities"
output: html_notebook
---
goal: turn this pipeline into a function for easy analysis of multiple states

ADD POPULATION HEATMAP AND MAJOR CITIES

import data

```{r}
ev_locations <- read_csv("data/ev_station_locations.csv") |>
    filter(!is.na(latitude), !is.na(longitude))

ev_locations
```

get city data from natural earth

```{r}
library(rnaturalearth)
library(janitor)

cities <- rnaturalearth::ne_download(
  scale = "medium",
  type = "populated_places",
  category = "cultural",
  returnclass = "sf"
) |> janitor::clean_names()
```

```{r}
library(tidyverse)
library(sf)
library(tidycensus)
library(osmdata)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(scales)

analyze_ev_coverage <- function(state_abbr, buffer) {
  
  # filter EV locations to selected state
  ev_locations_state <- ev_locations |> filter(state == state_abbr)
  coords <- ev_locations_state |> select(longitude, latitude) |> as.data.frame()
  stations_sf <- st_as_sf(coords, 
                          coords = c("longitude", "latitude"), 
                          crs = 4326
                          ) |> st_make_valid()
  
  # debug
  if (nrow(ev_locations_state) == 0) {
    warning(paste("No EV stations found for", state_abbr))
    return(NULL)
  }
  
  # get population data for counties in selected state
  population <- get_acs(geography = "county",
                      variables = "B01003_001",
                      year = 2022,
                      geometry = TRUE,
                      state = state_abbr)
  
  population <- st_transform(population, st_crs(stations_sf)) |> 
    st_make_valid()
  
  if(any(sf::st_geometry_type(population) == "GEOMETRYCOLLECTION")) {
    population <- population |>
      mutate(geometry = st_collection_extract(geometry, "POLYGON"))
  }
  
  population <- population |>
  mutate(area_mi2 = as.numeric(st_area(geometry)) / 2.59e6,
         pop_density = estimate / area_mi2)
  
  # incorporate city data
  state_full <- state.name[match(state_abbr, state.abb)]
  
  cities_state <- cities |>
    filter(
      iso_a2 == "US",
      pmax(pop_max, pop_min, na.rm = TRUE) >= 100000
    ) |>
    st_transform(st_crs(population))
  
  #create bbox
  bbox <- st_bbox(population)
  
  # create buffers (enter in miles and it will convert to meters)
  buffers <- st_buffer(stations_sf, dist = buffer * 1609)
  coverage_area <-st_make_valid(st_union(buffers))
  
  # determine uncovered areas
  uncovered <- st_make_valid(st_difference(st_union(st_geometry(population)), coverage_area))
  
  # plot coverage map
  ggplot() +
    geom_sf(data = population, aes(fill = pop_density), color = "white", size = 0.2) +
    scale_fill_viridis_c(option = "viridis", 
                         trans = "log",
                         limits = c(10, 10000),
                         breaks = c(10, 100, 1000, 10000),
                         labels = label_comma(accuracy = 1),
                         name = bquote("Population Density (people/mi"^2*")")) +
    geom_sf(data = st_boundary(coverage_area), color = "magenta", alpha = 1, size = 1.5) +
    geom_sf(data = cities_state, color = "black", size = 2, shape = 21, fill = "yellow") +
    geom_text(data = cities_state,
              aes(label = name, geometry = geometry),
              stat = "sf_coordinates",
              size = 3,
              nudge_y = 0.1) +
    coord_sf(xlim = c(bbox["xmin"], bbox["xmax"]), ylim = c(bbox["ymin"], bbox["ymax"]), expand = FALSE) +
    ggtitle(paste0(state_abbr, " EV Station Coverage with Population Density (", buffer, " Mile Convenience)")) +
    labs(subtitle = paste("Areas inside magenta boundaries are within", buffer, "miles of an EV station"))
  
  # save to file
  ggsave(paste0("outputs/coverage_maps_with_population_cities/ev_station_coverage_with_population_cities_", state_abbr, "_", buffer, "mi.png"))
}
```

test function

```{r}
analyze_ev_coverage("NJ", 5)
```

excellent!
now, let's use it to check out the top underbuilt states + PA

```{r}
top_underbuilt_states <- c("TX", "FL", "NJ", "IL", "NV", "PA")
buffers <- c(5, 10, 15, 20)

for (state in top_underbuilt_states) {
  for (buffer in buffers) {
    cat("Creating coverage map for", state, "with buffer", buffer, "miles...\n")
    plot_obj <- analyze_ev_coverage(state, buffer)
  }
}
```