---
title: "EV Infrastructure Modeling"
output: html_notebook
---

Part 2: Modeling

---

import datasets from cleaning file

```{r}
ev_combined_pop <- read.csv("data/ev_combined_pop.csv")
ev_stats <- read.csv("data/ev_stats.csv")
```


predictive linear modeling based on registrations and population
goal: predict the number of stations that each state should have based on registration count and population

```{r}
model_lm = lm(total_stations ~ registration_count + population, data = ev_combined_pop)
summary(model_lm)
```

predict stations based on model
expected stations = stations the model predicts should exist in each state based solely on registrations and population
station gap = difference between expected stations and current stations

```{r}
ev_combined_pop <- ev_combined_pop |>
  mutate(expected_stations = round(predict(model_lm), 0),
         station_gap = expected_stations - total_stations) |>
  arrange(desc(station_gap))

ev_combined_pop
```

visualize station gap from linear model

```{r}
plot_usmap(data = ev_combined_pop, values = "station_gap", color = "white") + 
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red",
    midpoint = 0, name = "Station Gap"
  ) +
  labs(
    title = "EV Charging Station Gaps by State (LM w/ Registration + Population)",
    subtitle = "Red = Underbuilt, Blue = Overbuilt"
  )

ggsave("outputs/ev_charging_station_gaps_by_state_1.png", bg = "skyblue")
```

```{r}
ev_combined_pop_10 <- ev_combined_pop |>
  head(10)

ggplot(ev_combined_pop_10, aes(x = reorder(state, -station_gap), y = station_gap)) + 
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    title = "Top 10 Underbuilt EV States (LM w/ Registration + Population)",
    x = "State",
    y = "Station Gap"
  ) + 
  geom_text(aes(label = station_gap), vjust = -0.2)

ggsave("outputs/top_10_underbuilt_states_1.png")
```
 
now, let's get crazy

I believe it is a fair assumption to say that the average person does not worry about where to fuel up
when driving an internal combustion engine (ICE) vehicle. Unless driving in extremely rural areas, gas
stations are readily available, have enough bays, and experience minimal downtime. Let's do a better
job predicting how many EVs each state will need based on the current gasoline infrastructure.

Gas Station Data: https://afdc.energy.gov/files/u/data/data_source/10333/10333_gasoline_stations_year.xlsx

downside: data only through 2012 (historical trends show a decline in number of gas stations since 1996)

import and clean up data

```{r}
gas_stations <- read.csv("data/2012_gas_stations_us.csv")

gas_stations <- gas_stations |>
  rename(gas_stations = X2012) |>
  rename(state = State)

gas_stations$state <- state.abb[match(gas_stations$state, state.name)]


gas_stations
```

join with ev_stats data for analysis

```{r}
ev_gas_stations <- ev_stats |>
  left_join(gas_stations) |>
  select(state, total_stations, gas_stations) |>
  mutate(difference = gas_stations - total_stations) |>
  arrange(desc(difference))

ev_gas_stations
```

according to this data, there are only three states with more EV stations than gas stations (CO, MA, CA)
all other states have more gas stations than EV stations

let's do some math with the gas station data and factor that into the model
goal: predict the number of EV stations each state needs but factor in the number of gas stations this time

```{r}
ev_gas_stats <- ev_stats |>
  left_join(gas_stations)

model_lm_gas = lm(total_stations ~ registration_count + population + gas_stations, data = ev_gas_stats)
summary(model_lm_gas)
```

number of gas stations is not significant, so it most likely did not alter the model much

let's look at the predictions from this model

```{r}
ev_gas_predicted <- ev_gas_stats |>
  mutate(expected_stations = round(predict(model_lm_gas), 0),
         station_gap = expected_stations - total_stations) |>
  arrange(desc(station_gap))

ev_gas_predicted
```

visualize station gap from the new linear model with gas stations included

```{r}
plot_usmap(data = ev_gas_predicted, values = "station_gap", color = "white") + 
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red",
    midpoint = 0, name = "Station Gap"
  ) +
  labs(
    title = "EV Charging Station Gaps by State (LM w/ Registration + Population + Gas Stations)",
    subtitle = "Red = Underbuilt, Blue = Overbuilt"
  )

ggsave("outputs/ev_charging_station_gaps_by_state_2.png", bg = "skyblue")
```

similar results, so let's try a random forest regressor

```{r}
library(randomForest)

model_rfr_gas = randomForest(total_stations ~ registration_count + population + gas_stations, data = ev_gas_stats)
summary(model_rfr_gas)
```

```{r}
ev_gas_predicted_rfr <- ev_gas_stats |>
  mutate(expected_stations = round(predict(model_rfr_gas), 0),
         station_gap = expected_stations - total_stations) |>
  arrange(desc(station_gap))

ev_gas_predicted_rfr
```

random forest considers CA to be vastly overbuilt (which is not true in actuality, but may be compared to other states)

```{r}
plot_usmap(data = ev_gas_predicted_rfr, values = "station_gap", color = "white") + 
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red",
    midpoint = 0, name = "Station Gap"
  ) +
  labs(
    title = "EV Charging Station Gaps by State (RF w/ Registration + Population + Gas Stations)",
    subtitle = "Red = Underbuilt, Blue = Overbuilt"
  )

ggsave("outputs/ev_charging_station_gaps_by_state_3.png", bg = "skyblue")
```

let's try gradient boosting before I add any additional features to the analysis
 
```{r}
library(gbm)

model_gbm_gas = gbm(total_stations ~ registration_count + population + gas_stations, data = ev_gas_stats,
                    distribution = "gaussian", n.trees = 100)
summary(model_gbm_gas)
```

```{r}
ev_gas_predicted_gbm <- ev_gas_stats |>
  mutate(expected_stations = round(predict(model_gbm_gas), 0),
         station_gap = expected_stations - total_stations) |>
  arrange(desc(station_gap))

ev_gas_predicted_gbm
```

```{r}
plot_usmap(data = ev_gas_predicted_gbm, values = "station_gap", color = "white") + 
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red",
    midpoint = 0, name = "Station Gap"
  ) +
  labs(
    title = "EV Charging Station Gaps by State (GBM w/ Registration + Population + Gas Stations)",
    subtitle = "Red = Underbuilt, Blue = Overbuilt"
  )

ggsave("outputs/ev_charging_station_gaps_by_state_4.png", bg = "skyblue")
```

CA seems to be considered vastly overbuilt every time
This may be true based on other states, but I would hardly consider any state to be considered overbuilt in the
current, growing EV market.
To remedy this issue, I would like to factor in geographic area to the models.

let's clean up some of the column names before this gets even more confusing

```{r}
ev_gas <- ev_gas_stats |>
  rename(ev_stations = total_stations,
         ev_registrations = registration_count)

ev_gas
``` 

import state geographic data and convert to state abbreviations
State Area Data: https://www.census.gov/geographies/reference-files/2010/geo/state-area.html

```{r}
state_areas <- read.csv("data/state_areas.csv")
state_areas$state <- state.abb[match(state_areas$state, state.name)]
state_areas
```

join with dataset

```{r}
ev_gas_area <- ev_gas |>
  left_join(state_areas) |>
  arrange(desc(sq_mi))

ev_gas_area
```

create new linear model factoring in sq_miles (land area for each state)
note: re-running other models with same dataset for analysis

```{r}
model_lm <- lm(ev_stations ~ ev_registrations + population, data = ev_gas_area)
model_lm_gas <- lm(ev_stations ~ ev_registrations + population + gas_stations, data = ev_gas_area)
model_lm_area <- lm(ev_stations ~ ev_registrations + population + sq_mi, data = ev_gas_area)
model_lm_gas_area<- lm(ev_stations ~ ev_registrations + population + gas_stations + sq_mi, data = ev_gas_area)

summary(model_lm)
summary(model_lm_gas)
summary(model_lm_area)
summary(model_lm_gas_area)
```

visualize based on combination

```{r}
ev_gas_area_predicted_lm<- ev_gas_area |>
  mutate(expected_stations = round(predict(model_lm_gas_area), 0),
         station_gap = expected_stations - ev_stations) |>
  arrange(desc(station_gap))

ev_gas_area_predicted_lm
```

```{r}
plot_usmap(data = ev_gas_area_predicted_lm, values = "station_gap", color = "white") + 
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red",
    midpoint = 0, name = "Station Gap"
  ) +
  labs(
    title = "EV Charging Station Gaps by State (LM w/ Registration + Population + Gas Stations + Area)",
    subtitle = "Red = Underbuilt, Blue = Overbuilt"
  )

ggsave("outputs/ev_charging_station_gaps_by_state_5.png", bg = "skyblue")
```
I like the looks of this map. Including area seemed to eliminate some of the extreme predictions.
This now seems like a much more nuanced look at which states are under- or overbuilt.
But do the statistics agree?

```{r}
anova(model_lm, model_lm_gas)
anova(model_lm, model_lm_area)
anova(model_lm, model_lm_gas_area)
```

adding gas, gas+area does not result in statistical significance against the original model
however, adding area does work to eliminate extremes, so may not be completely useless

let's try a random forest model just to see if it may do a better job

```{r}
model_rfr <- randomForest(ev_stations ~ ev_registrations + population, data = ev_gas_area)
model_rfr_gas <- randomForest(ev_stations ~ ev_registrations + population + gas_stations, data = ev_gas_area)
model_rfr_area <- randomForest(ev_stations ~ ev_registrations + population + sq_mi, data = ev_gas_area)
model_rfr_gas_area<- randomForest(ev_stations ~ ev_registrations + population + gas_stations + sq_mi, data = ev_gas_area)

importance(model_rfr)
importance(model_rfr_gas)
importance(model_rfr_area)
importance(model_rfr_gas_area)
```

```{r}
library(rfPermute)

model_rfr_perm <- rfPermute(ev_stations ~ ev_registrations + population, data = ev_gas_area)
model_rfr_gas_perm <- rfPermute(ev_stations ~ ev_registrations + population + gas_stations, data = ev_gas_area)
model_rfr_area_perm <- rfPermute(ev_stations ~ ev_registrations + population + sq_mi, data = ev_gas_area)
model_rfr_gas_area_perm <- rfPermute(ev_stations ~ ev_registrations + population + gas_stations + sq_mi, data = ev_gas_area)

summary(model_rfr_perm)
summary(model_rfr_gas_perm)
summary(model_rfr_area_perm)
summary(model_rfr_gas_area_perm)
```
rfr performed poorly, so I will stick with the linear model
why - too low percentage of explained variance
